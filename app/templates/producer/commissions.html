{#
Template de gestión de comisiones para productores en Gem-AvatART.

Este template permite a los productores ver y gestionar todas las comisiones
relacionadas con su equipo. Incluye visualización de comisiones activas,
historial de pagos, configuración de tarifas y análisis de rendimiento
financiero del equipo.

El template incluye:
    - Dashboard de comisiones con métricas principales
    - Lista de comisiones pendientes y procesadas
    - Configuración de tarifas por tipo de reel
    - Historial de pagos del equipo
    - Análisis de rendimiento financiero
    - Gestión de bonificaciones y descuentos
    - Reportes de comisiones por período

Clases Bootstrap utilizadas:
    - Layout: container-fluid, row, col-*, d-flex
    - Cards: card, card-body, card-header, card-title
    - Tables: table, table-striped, table-hover, table-responsive
    - Badges: badge, bg-success, bg-warning, bg-danger, bg-info
    - Buttons: btn, btn-primary, btn-outline-*, btn-sm
    - Forms: form-control, form-select, input-group
    - Modals: modal, modal-dialog, modal-content
    - Progress: progress, progress-bar
    - Typography: text-muted, text-center, fw-bold
    - Spacing: mb-*, mt-*, p-*, g-3

Variables Jinja utilizadas:
    - current_user: Usuario productor autenticado
    - pending_commissions: Comisiones pendientes de pago
    - processed_commissions: Comisiones ya procesadas
    - commission_stats: Estadísticas de comisiones
    - team_earnings: Ganancias por miembro del equipo
    - rate_settings: Configuración de tarifas

Rutas Flask referenciadas (url_for):
    - producer.dashboard: Volver al dashboard
    - producer.commission_detail: Ver detalle de comisión
    - producer.configure_rates: Configurar tarifas
    - producer.export_report: Exportar reporte
    - producer.process_payment: Procesar pago

Información de comisión mostrada:
    - ID y fecha de la comisión
    - Miembro del equipo
    - Tipo de reel creado
    - Monto y estado de pago
    - Fechas de creación y procesamiento
    - Observaciones y detalles

Filtros disponibles:
    - date_range: Rango de fechas
    - status: Estado de la comisión
    - member: Miembro del equipo
    - amount_range: Rango de montos

Iconografía Font Awesome:
    - fas fa-dollar-sign: Comisiones y dinero
    - fas fa-chart-line: Gráficos y estadísticas
    - fas fa-download: Exportar reportes
    - fas fa-cog: Configuración de tarifas
    - fas fa-clock: Comisiones pendientes
    - fas fa-check-circle: Comisiones procesadas
    - fas fa-user: Miembros del equipo
    - fas fa-calendar: Fechas y períodos
    - fas fa-eye: Ver detalles
    - fas fa-credit-card: Pagos

Estados de comisión:
    - pending: Pendiente de pago
    - processing: En proceso
    - paid: Pagada
    - cancelled: Cancelada
    - disputed: En disputa
#}

{% extends "base.html" %}

{% block title %}Gestión de Comisiones - Productor - Gem-AvatART{% endblock %}

{% block content %}
<!-- Contenedor principal con layout fluido -->
<div class="container-fluid">
    <!-- Header de la página con navegación -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <!-- Título principal con icono representativo -->
            <h1 class="mb-1"><i class="fas fa-dollar-sign text-success"></i> Gestión de Comisiones</h1>
            <!-- Breadcrumb de navegación -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('producer.dashboard') }}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active">Comisiones</li>
                </ol>
            </nav>
        </div>
        
        <!-- Acciones principales -->
        <div class="btn-group">
            <a href="{{ url_for('producer.configure_rates') }}" class="btn btn-outline-primary">
                <i class="fas fa-cog"></i> Configurar Tarifas
            </a>
            <button type="button" class="btn btn-success" onclick="exportReport()">
                <i class="fas fa-download"></i> Exportar Reporte
            </button>
        </div>
    </div>

    <!-- Fila de métricas principales -->
    <div class="row g-3 mb-4">
        <!-- Total comisiones este mes -->
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-dollar-sign fa-3x me-3"></i>
                        <div>
                            <h3 class="mb-0">${{ "%.2f"|format(commission_stats.total_this_month if commission_stats else 0) }}</h3>
                            <p class="mb-0">Total Este Mes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comisiones pendientes -->
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock fa-3x me-3"></i>
                        <div>
                            <h3 class="mb-0">{{ pending_commissions|length if pending_commissions else 0 }}</h3>
                            <p class="mb-0">Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promedio por reel -->
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line fa-3x me-3"></i>
                        <div>
                            <h3 class="mb-0">${{ "%.2f"|format(commission_stats.average_per_reel if commission_stats else 0) }}</h3>
                            <p class="mb-0">Promedio/Reel</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total miembros con comisiones -->
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user fa-3x me-3"></i>
                        <div>
                            <h3 class="mb-0">{{ team_earnings|length if team_earnings else 0 }}</h3>
                            <p class="mb-0">Miembros Activos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <!-- Filtro por rango de fechas -->
                <div class="col-md-3">
                    <label class="form-label">Fecha Desde</label>
                    <input type="date" name="date_from" class="form-control" 
                           value="{{ request.args.get('date_from', '') }}">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Fecha Hasta</label>
                    <input type="date" name="date_to" class="form-control" 
                           value="{{ request.args.get('date_to', '') }}">
                </div>

                <!-- Filtro por estado -->
                <div class="col-md-2">
                    <label class="form-label">Estado</label>
                    <select name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="pending" {{ 'selected' if request.args.get('status') == 'pending' }}>
                            Pendiente
                        </option>
                        <option value="processing" {{ 'selected' if request.args.get('status') == 'processing' }}>
                            Procesando
                        </option>
                        <option value="paid" {{ 'selected' if request.args.get('status') == 'paid' }}>
                            Pagada
                        </option>
                        <option value="cancelled" {{ 'selected' if request.args.get('status') == 'cancelled' }}>
                            Cancelada
                        </option>
                    </select>
                </div>

                <!-- Filtro por miembro -->
                <div class="col-md-2">
                    <label class="form-label">Miembro</label>
                    <select name="member" class="form-select">
                        <option value="">Todos</option>
                        {% if team_earnings %}
                            {% for member in team_earnings %}
                                <option value="{{ member.user_id }}" 
                                        {{ 'selected' if request.args.get('member')|int == member.user_id }}>
                                    {{ member.full_name }}
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Botón de filtro -->
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Pestañas de navegación -->
    <ul class="nav nav-tabs mb-4" id="commissionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                <i class="fas fa-clock"></i> Pendientes ({{ pending_commissions|length if pending_commissions else 0 }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#processed" type="button">
                <i class="fas fa-check-circle"></i> Procesadas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analytics" type="button">
                <i class="fas fa-chart-line"></i> Análisis
            </button>
        </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content">
        <!-- Pestaña de comisiones pendientes -->
        <div class="tab-pane fade show active" id="pending">
            {% if pending_commissions %}
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Comisiones Pendientes</h5>
                        <button class="btn btn-sm btn-success" onclick="processAllPending()">
                            <i class="fas fa-credit-card"></i> Procesar Todas
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Miembro</th>
                                        <th>Reel</th>
                                        <th>Tipo</th>
                                        <th>Monto</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for commission in pending_commissions %}
                                    <tr>
                                        <td class="fw-bold">#{{ commission.id }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if commission.user.profile_picture %}
                                                    <img src="{{ commission.user.profile_picture }}" 
                                                         class="rounded-circle me-2" 
                                                         width="32" height="32" alt="Profile">
                                                {% else %}
                                                    <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                         style="width: 32px; height: 32px;">
                                                        <i class="fas fa-user text-white small"></i>
                                                    </div>
                                                {% endif %}
                                                <div>
                                                    <strong>{{ commission.user.full_name }}</strong>
                                                    <br><small class="text-muted">@{{ commission.user.username }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('producer.reel_detail', reel_id=commission.reel.id) if commission.reel else '#' }}" 
                                               class="text-decoration-none">
                                                {{ commission.reel.title[:30] if commission.reel else 'N/A' }}{% if commission.reel and commission.reel.title|length > 30 %}...{% endif %}
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ commission.reel_type if commission.reel_type else 'Standard' }}</span>
                                        </td>
                                        <td class="fw-bold text-success">${{ "%.2f"|format(commission.amount) }}</td>
                                        <td>{{ commission.created_at.strftime('%d/%m/%Y') if commission.created_at else 'N/A' }}</td>
                                        <td>
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock"></i> {{ commission.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" 
                                                        onclick="viewCommissionDetail({{ commission.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success" 
                                                        onclick="processCommission({{ commission.id }})">
                                                    <i class="fas fa-credit-card"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                    <h3 class="text-muted">No hay comisiones pendientes</h3>
                    <p class="text-muted">Todas las comisiones están al día.</p>
                </div>
            {% endif %}
        </div>

        <!-- Pestaña de comisiones procesadas -->
        <div class="tab-pane fade" id="processed">
            {% if processed_commissions %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Historial de Comisiones Procesadas</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Miembro</th>
                                        <th>Monto</th>
                                        <th>Procesada</th>
                                        <th>Estado</th>
                                        <th>Método</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for commission in processed_commissions %}
                                    <tr>
                                        <td class="fw-bold">#{{ commission.id }}</td>
                                        <td>{{ commission.user.full_name }}</td>
                                        <td class="fw-bold text-success">${{ "%.2f"|format(commission.amount) }}</td>
                                        <td>{{ commission.processed_at.strftime('%d/%m/%Y %H:%M') if commission.processed_at else 'N/A' }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if commission.status == 'paid' else 'danger' }}">
                                                <i class="fas fa-{{ 'check' if commission.status == 'paid' else 'times' }}"></i> 
                                                {{ commission.status.title() }}
                                            </span>
                                        </td>
                                        <td>{{ commission.payment_method or 'Transfer' }}</td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="viewCommissionDetail({{ commission.id }})">
                                                <i class="fas fa-eye"></i> Ver
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-history fa-5x text-muted mb-4"></i>
                    <h3 class="text-muted">No hay historial de comisiones</h3>
                    <p class="text-muted">Las comisiones procesadas aparecerán aquí.</p>
                </div>
            {% endif %}
        </div>

        <!-- Pestaña de análisis -->
        <div class="tab-pane fade" id="analytics">
            <div class="row g-4">
                <!-- Gráfico de comisiones por mes -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Comisiones por Mes</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="commissionsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top miembros por comisiones -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Top Miembros</h5>
                        </div>
                        <div class="card-body">
                            {% if team_earnings %}
                                {% for member in team_earnings[:5] %}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong>{{ member.full_name }}</strong>
                                        <br><small class="text-muted">{{ member.total_reels }} reels</small>
                                    </div>
                                    <div class="text-end">
                                        <strong class="text-success">${{ "%.2f"|format(member.total_earnings) }}</strong>
                                        <br><small class="text-muted">{{ member.commission_count }} comisiones</small>
                                    </div>
                                </div>
                                {% if not loop.last %}<hr>{% endif %}
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center">No hay datos disponibles</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Configuración de tarifas actual -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Configuración Actual de Tarifas</h5>
                        </div>
                        <div class="card-body">
                            {% if rate_settings %}
                                <div class="row g-3">
                                    {% for rate in rate_settings %}
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">{{ rate.reel_type.title() }}</h6>
                                                <h4 class="text-primary">${{ "%.2f"|format(rate.rate) }}</h4>
                                                <small class="text-muted">por reel</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No se han configurado tarifas personalizadas.</p>
                                <a href="{{ url_for('producer.configure_rates') }}" class="btn btn-primary">
                                    <i class="fas fa-cog"></i> Configurar Tarifas
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de detalle de comisión -->
<div class="modal fade" id="commissionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Comisión</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="commissionDetailContent">
                    <!-- El contenido se cargará dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de procesamiento de comisión -->
<div class="modal fade" id="processModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Procesar Comisión</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="processForm">
                    <div class="mb-3">
                        <label class="form-label">Método de Pago</label>
                        <select class="form-select" name="payment_method" required>
                            <option value="">Seleccionar método</option>
                            <option value="bank_transfer">Transferencia Bancaria</option>
                            <option value="paypal">PayPal</option>
                            <option value="crypto">Criptomoneda</option>
                            <option value="check">Cheque</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmProcessing()">
                    <i class="fas fa-credit-card"></i> Procesar Pago
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para funcionalidad dinámica -->
<script>
let currentCommissionId = null;

// Ver detalle de comisión
function viewCommissionDetail(commissionId) {
    fetch(`/producer/commission/${commissionId}/detail`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td>#${data.id}</td></tr>
                            <tr><td><strong>Miembro:</strong></td><td>${data.user_name}</td></tr>
                            <tr><td><strong>Monto:</strong></td><td class="text-success fw-bold">$${data.amount}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td><span class="badge bg-${data.status_color}">${data.status}</span></td></tr>
                            <tr><td><strong>Creada:</strong></td><td>${data.created_at}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Detalle del Reel</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Título:</strong></td><td>${data.reel_title}</td></tr>
                            <tr><td><strong>Tipo:</strong></td><td>${data.reel_type}</td></tr>
                            <tr><td><strong>Duración:</strong></td><td>${data.reel_duration}s</td></tr>
                            <tr><td><strong>Avatar:</strong></td><td>${data.avatar_name}</td></tr>
                        </table>
                    </div>
                </div>
                ${data.notes ? `<div class="mt-3"><h6>Observaciones</h6><p class="text-muted">${data.notes}</p></div>` : ''}
            `;
            document.getElementById('commissionDetailContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('commissionDetailModal')).show();
        });
}

// Procesar una comisión
function processCommission(commissionId) {
    currentCommissionId = commissionId;
    new bootstrap.Modal(document.getElementById('processModal')).show();
}

// Confirmar procesamiento
function confirmProcessing() {
    const form = document.getElementById('processForm');
    const formData = new FormData(form);
    
    fetch(`/producer/commission/${currentCommissionId}/process`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('processModal')).hide();
            location.reload(); // Recargar para mostrar cambios
        } else {
            alert('Error al procesar la comisión');
        }
    });
}

// Procesar todas las comisiones pendientes
function processAllPending() {
    if (confirm('¿Está seguro de procesar todas las comisiones pendientes?')) {
        fetch('/producer/commissions/process-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al procesar las comisiones');
            }
        });
    }
}

// Exportar reporte
function exportReport() {
    const params = new URLSearchParams(window.location.search);
    const url = '/producer/commissions/export?' + params.toString();
    window.open(url, '_blank');
}

// Gráfico de comisiones (Chart.js - si está disponible)
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('commissionsChart');
    if (ctx && typeof Chart !== 'undefined') {
        // Datos de ejemplo - en producción vendrían del backend
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{
                    label: 'Comisiones ($)',
                    data: [{{ commission_stats.monthly_data|join(',') if commission_stats and commission_stats.monthly_data else '0,0,0,0,0,0' }}],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}