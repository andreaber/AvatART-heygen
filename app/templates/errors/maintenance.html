{#}
Template de página de mantenimiento para Gem-AvatART.

Este template se muestra cuando la aplicación está en modo mantenimiento
programado. Proporciona información sobre el mantenimiento en curso,
tiempo estimado de finalización, y mantiene la marca y diseño de la aplicación.

El template incluye:
    - Mensaje claro sobre el estado de mantenimiento
    - Tiempo estimado de finalización
    - Información sobre qué servicios están afectados
    - Canales de comunicación durante el mantenimiento
    - Countdown dinámico hasta la finalización
    - Enlaces a redes sociales para actualizaciones
    - Información de contacto de emergencia

Clases Bootstrap utilizadas:
    - Layout: container, row, col-*, justify-content-center
    - Typography: display-1, lead, text-center, text-info
    - Cards: card, card-body, card-header, card-footer
    - Buttons: btn, btn-outline-*, btn-lg
    - Alerts: alert, alert-info, alert-warning
    - Progress: progress, progress-bar
    - Spacing: mt-*, mb-*, p-*
    - Utilities: d-flex, text-center, align-items-center

Variables Jinja utilizadas:
    - maintenance_end_time: Hora estimada de finalización
    - maintenance_reason: Razón del mantenimiento
    - affected_services: Lista de servicios afectados
    - estimated_duration: Duración estimada en minutos
    - maintenance_type: Tipo de mantenimiento (scheduled, emergency)

Iconografía Font Awesome:
    - fas fa-tools: Herramientas de mantenimiento
    - fas fa-clock: Tiempo estimado
    - fas fa-server: Servicios del servidor
    - fas fa-info-circle: Información
    - fas fa-external-link-alt: Enlaces externos
    - fab fa-twitter, fab fa-facebook: Redes sociales

Funcionalidades JavaScript:
    - Countdown timer en tiempo real
    - Auto-refresh cada cierto tiempo
    - Verificación de estado del servidor
    - Animaciones de mantenimiento
#}

{% extends "base.html" %}

{% block title %}Mantenimiento Programado - Gem-AvatART{% endblock %}

{% block content %}
<!-- Contenedor principal con espaciado -->
<div class="container mt-5">
    <!-- Fila centrada para el contenido de mantenimiento -->
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- Card principal de mantenimiento -->
            <div class="card shadow-lg border-0">
                <div class="card-header bg-info text-white text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Mantenimiento en Progreso
                    </h4>
                </div>
                
                <div class="card-body text-center p-5">
                    <!-- Icono de herramientas animado -->
                    <div class="mb-4">
                        <i class="fas fa-tools text-info maintenance-icon" style="font-size: 5rem;"></i>
                    </div>
                    
                    <!-- Título principal -->
                    <h1 class="display-4 text-info fw-bold mb-3">En Mantenimiento</h1>
                    
                    <!-- Descripción del mantenimiento -->
                    <p class="lead text-muted mb-4">
                        Estamos realizando mejoras en nuestros servidores para ofrecerte 
                        una mejor experiencia. Gem-AvatART estará de vuelta muy pronto.
                    </p>
                    
                    <!-- Información específica del mantenimiento -->
                    <div class="alert alert-info" role="alert">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-info-circle fa-2x me-3"></i>
                            <div class="text-start">
                                <h6 class="alert-heading mb-1">
                                    {{ maintenance_reason if maintenance_reason else 'Mantenimiento Programado' }}
                                </h6>
                                <p class="mb-0">
                                    {% if maintenance_type == 'emergency' %}
                                        Estamos solucionando un problema técnico para mejorar la estabilidad del servicio.
                                    {% else %}
                                        Implementando nuevas funcionalidades y optimizaciones de rendimiento.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Countdown timer -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-clock me-2"></i>Tiempo Estimado Restante
                            </h5>
                            <div id="countdown" class="display-6 text-primary fw-bold">
                                --:--:--
                            </div>
                            <small class="text-muted">
                                Finalización estimada: {{ maintenance_end_time if maintenance_end_time else 'Por determinar' }}
                            </small>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso del mantenimiento -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Progreso del mantenimiento</span>
                            <span class="text-muted" id="progressPercent">65%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 65%" id="progressBar">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estado de servicios -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-server text-warning fa-2x mb-2"></i>
                                    <h6>Servicios Principales</h6>
                                    <span class="badge bg-warning">En Mantenimiento</span>
                                    <small class="d-block text-muted mt-2">
                                        Generación de avatars, dashboard, equipos
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-envelope text-success fa-2x mb-2"></i>
                                    <h6>Comunicaciones</h6>
                                    <span class="badge bg-success">Operativo</span>
                                    <small class="d-block text-muted mt-2">
                                        Email, notificaciones, soporte
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="row g-3">
                        <!-- Qué está pasando -->
                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-cogs me-2"></i>¿Qué estamos haciendo?
                                    </h6>
                                    <ul class="list-unstyled small text-muted mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Actualización de seguridad</li>
                                        <li><i class="fas fa-spinner fa-spin text-info me-2"></i>Optimización de base de datos</li>
                                        <li><i class="fas fa-clock text-warning me-2"></i>Mejoras en la API de avatars</li>
                                        <li><i class="fas fa-clock text-warning me-2"></i>Actualización del sistema</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mantente informado -->
                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-bell me-2"></i>Mantente Informado
                                    </h6>
                                    <div class="d-grid gap-2">
                                        <a href="https://twitter.com/gem_avatart" target="_blank" 
                                           class="btn btn-outline-info btn-sm">
                                            <i class="fab fa-twitter me-2"></i>Síguenos en Twitter
                                        </a>
                                        <a href="mailto:status@gem-avatart.com" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-envelope me-2"></i>Notificaciones por Email
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer con información de contacto -->
                <div class="card-footer bg-light text-center">
                    <h6 class="mb-3">¿Necesitas Ayuda Urgente?</h6>
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <a href="mailto:soporte@gem-avatart.com" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-envelope me-1"></i> soporte@gem-avatart.com
                        </a>
                        <a href="tel:+1234567890" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-phone me-1"></i> +1 (234) 567-890
                        </a>
                        <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#statusModal">
                            <i class="fas fa-chart-line me-1"></i> Estado del Sistema
                        </button>
                    </div>
                    <small class="text-muted d-block mt-3">
                        <i class="fas fa-clock me-1"></i>
                        Inicio del mantenimiento: {{ moment().format('DD/MM/YYYY HH:mm') if moment else 'N/A' }}
                    </small>
                </div>
            </div>
            
            <!-- Información adicional sobre el mantenimiento -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Actualizaciones del Mantenimiento
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <i class="fas fa-play text-info"></i>
                            <strong>14:00</strong> - Inicio del mantenimiento programado
                        </div>
                        <div class="timeline-item">
                            <i class="fas fa-check text-success"></i>
                            <strong>14:15</strong> - Actualización de seguridad completada
                        </div>
                        <div class="timeline-item">
                            <i class="fas fa-spinner fa-spin text-warning"></i>
                            <strong>14:30</strong> - Optimizando base de datos (en progreso)
                        </div>
                        <div class="timeline-item text-muted">
                            <i class="fas fa-clock text-muted"></i>
                            <strong>15:00</strong> - Reinicio de servicios (estimado)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de estado del sistema -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>Estado Detallado del Sistema
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>API Principal</strong>
                            <span class="badge bg-danger">Fuera de Servicio</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-danger" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Base de Datos</strong>
                            <span class="badge bg-warning">Mantenimiento</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-warning" style="width: 60%"></div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Sistema de Autenticación</strong>
                            <span class="badge bg-success">Operativo</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Servicios de Notificación</strong>
                            <span class="badge bg-success">Operativo</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i> Actualizar Estado
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para funcionalidad de mantenimiento -->
<script>
// Variables globales
let countdownInterval;
let progressInterval;
let maintenanceEndTime;

// Inicializar countdown
function initializeCountdown() {
    // Establecer tiempo de finalización (ejemplo: 1 hora desde ahora)
    const now = new Date();
    maintenanceEndTime = new Date(now.getTime() + ({{ estimated_duration if estimated_duration else 60 }} * 60 * 1000));
    
    countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown(); // Actualizar inmediatamente
}

// Actualizar countdown
function updateCountdown() {
    const now = new Date();
    const timeLeft = maintenanceEndTime - now;
    
    if (timeLeft <= 0) {
        document.getElementById('countdown').textContent = '00:00:00';
        clearInterval(countdownInterval);
        
        // Verificar si el mantenimiento ha terminado
        setTimeout(checkMaintenanceStatus, 1000);
        return;
    }
    
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    
    const formattedTime = 
        String(hours).padStart(2, '0') + ':' +
        String(minutes).padStart(2, '0') + ':' +
        String(seconds).padStart(2, '0');
    
    document.getElementById('countdown').textContent = formattedTime;
}

// Simular progreso del mantenimiento
function simulateProgress() {
    let progress = 65;
    
    progressInterval = setInterval(() => {
        // Incrementar progreso gradualmente
        progress += Math.random() * 2;
        progress = Math.min(progress, 95); // No pasar del 95%
        
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        
        progressBar.style.width = progress + '%';
        progressPercent.textContent = Math.round(progress) + '%';
        
        // Si llegamos al 95%, detener la simulación
        if (progress >= 95) {
            clearInterval(progressInterval);
        }
    }, 10000); // Actualizar cada 10 segundos
}

// Verificar estado del mantenimiento
function checkMaintenanceStatus() {
    fetch('/api/maintenance-status')
        .then(response => response.json())
        .then(data => {
            if (!data.maintenance_mode) {
                // Mantenimiento terminado
                showMaintenanceComplete();
            } else {
                // Aún en mantenimiento, verificar nuevamente en 30 segundos
                setTimeout(checkMaintenanceStatus, 30000);
            }
        })
        .catch(error => {
            console.log('Error verificando estado del mantenimiento');
            // Verificar nuevamente en 1 minuto si hay error
            setTimeout(checkMaintenanceStatus, 60000);
        });
}

// Mostrar que el mantenimiento ha terminado
function showMaintenanceComplete() {
    const card = document.querySelector('.card');
    card.innerHTML = `
        <div class="card-header bg-success text-white text-center">
            <h4 class="mb-0">
                <i class="fas fa-check-circle me-2"></i>Mantenimiento Completado
            </h4>
        </div>
        <div class="card-body text-center p-5">
            <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
            <h1 class="display-4 text-success fw-bold mb-3">¡De Vuelta en Línea!</h1>
            <p class="lead text-muted mb-4">
                El mantenimiento ha sido completado exitosamente. 
                Gem-AvatART está funcionando normalmente.
            </p>
            <a href="/" class="btn btn-success btn-lg">
                <i class="fas fa-home me-2"></i>Acceder a la Aplicación
            </a>
        </div>
    `;
    
    // Auto-redirect después de 5 segundos
    setTimeout(() => {
        window.location.href = '/';
    }, 5000);
}

// Actualizar estado en el modal
function refreshStatus() {
    // Simular actualización del estado
    const badges = document.querySelectorAll('#statusModal .badge');
    badges.forEach(badge => {
        badge.textContent = 'Verificando...';
        badge.className = 'badge bg-secondary';
    });
    
    setTimeout(() => {
        // Restaurar estados (en una implementación real, esto vendría de la API)
        location.reload();
    }, 2000);
}

// Auto-refresh de la página
function scheduleAutoRefresh() {
    // Refrescar cada 5 minutos para verificar si el mantenimiento terminó
    setTimeout(() => {
        location.reload();
    }, 5 * 60 * 1000);
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    initializeCountdown();
    simulateProgress();
    scheduleAutoRefresh();
    
    // Agregar animación a los iconos
    const maintenanceIcon = document.querySelector('.maintenance-icon');
    if (maintenanceIcon) {
        setInterval(() => {
            maintenanceIcon.style.transform = 'rotate(15deg)';
            setTimeout(() => {
                maintenanceIcon.style.transform = 'rotate(-15deg)';
                setTimeout(() => {
                    maintenanceIcon.style.transform = 'rotate(0deg)';
                }, 500);
            }, 500);
        }, 3000);
    }
});

// Limpiar intervalos al salir
window.addEventListener('beforeunload', function() {
    if (countdownInterval) clearInterval(countdownInterval);
    if (progressInterval) clearInterval(progressInterval);
});
</script>

<!-- Estilos CSS para la página de mantenimiento -->
<style>
.maintenance-icon {
    transition: transform 0.5s ease;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding-bottom: 15px;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: -24px;
    top: 8px;
    width: 2px;
    height: 100%;
    background-color: #dee2e6;
}

.timeline-item:last-child:before {
    display: none;
}

.timeline-item i {
    position: absolute;
    left: -30px;
    top: 2px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    z-index: 1;
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

.card {
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}